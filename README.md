# sam-dfo-sw-api

# Description
* This API is really just a proxy wrapper to the Sitewise SDK API. Doesn;t do much more at the moment but achieves a few things:
  - Cleans up the response body to primarily be used in Grafana variable queries. Using the Grafana plugin for Sitewise is limited and the response payload is cumbersome.
  - Simplifies the need for any client applications from having to have the AWS SDK installed. 
  - Using the AWS API GW will enforce api-key for basic protection and usage plan metering.

- /regions?asset-root=x
  - GET - list of region assets associated to a root asset

- /labs?region-id=x,x,x
  - GET - list of lab assets associated to one or many regions

- /resource-groups?lab-id=x,x,x
  - GET - list of resource group assets associated with one or many labs

- /assets?resource-group-id=x,x,x
  - GET - list of device assets associated to one or many resource groups.


## Deploy the sample application

To build and deploy your application for the first time, run the following in your shell:

```bash
sam build
sam deploy --guided
```

## Use the AWS SAM CLI to build and test locally

Run functions locally and invoke them with the `sam local invoke` command.
***Note that the DOCKER_HOST env variable portion is for a bug in the sam cli...this may notbe needed with future sam cli updates...

```bash
DOCKER_HOST=unix:///Users/chobbins/.docker/run/docker.sock sam local invoke GetAssetLastLocation --region ca-central-1 --profile asea-session --event events/get-locations-event.json

DOCKER_HOST=unix:///Users/chobbins/.docker/run/docker.sock sam local invoke GetAssociatedAssets --region ca-central-1 --profile asea-session --event events/get-assoc-assets-event.json

DOCKER_HOST=unix:///Users/chobbins/.docker/run/docker.sock sam local invoke GetAssociatedAssets --region ca-central-1 --profile asea-session --event events/get-assoc-assets-event-dfo-root.json
```

The AWS SAM CLI can also emulate your application's API. Use the `sam local start-api` command to run the API locally on port 3000.

```bash
sam local start-api
curl http://localhost:3000/
```

## Fetch, tail, and filter Lambda function logs

To simplify troubleshooting, the AWS SAM CLI has a command called `sam logs`. `sam logs` lets you fetch logs that are generated by your Lambda function from the command line. In addition to printing the logs on the terminal, this command has several nifty features to help you quickly find the bug.

**NOTE:** This command works for all Lambda functions, not just the ones you deploy using AWS SAM.

```bash
sam logs -n GetAssetLastLocation --stack-name ssc-dfo-sam-sw-api --tail
```

## Unit tests

Tests are defined in the `__tests__` folder in this project. Use `npm` to install the [Jest test framework](https://jestjs.io/) and run unit tests.

```bash
npm install
npm run test
```

## Cleanup

To delete the sample application that you created, use the AWS CLI. Assuming you used your project name for the stack name, you can run the following:

```bash
aws cloudformation delete-stack --stack-name ssc-dfo-sam-sw-api --profile asea-session --region ca-central-1
```

- Use Case


